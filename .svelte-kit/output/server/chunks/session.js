import{w as C}from"./index.js";function E(e){if(!e||e.length<2)return[];const t={};for(const i of e){const o=x(i.judgment);t[o]||(t[o]=[]),t[o].push(i.worldview)}if(Object.keys(t).length===1)return[];const s=[],n=Object.keys(t);if(n.length>=2){const i=e.map(c=>c.worldview),o={};for(const[c,l]of Object.entries(t))o[c.toLowerCase()]=l;s.push({type:"judgment",worldviews:i,positions:o,description:`Worldviews disagree on judgment: ${n.join(" vs ")}`})}return s}function g(e){const t={healthcare:{Materialism:.9,Realism:.9,Rationalism:.85,Monadism:.7,Idealism:.65,Dynamism:.6,Psychism:.55,Phenomenalism:.5,Sensationalism:.45,Mathematism:.4,Spiritualism:.4,Pneumatism:.35},spiritual:{Spiritualism:.95,Idealism:.85,Psychism:.85,Pneumatism:.75,Rationalism:.6,Monadism:.55,Dynamism:.5,Phenomenalism:.45,Realism:.4,Mathematism:.4,Sensationalism:.35,Materialism:.3},education:{Idealism:.9,Rationalism:.85,Dynamism:.8,Monadism:.7,Psychism:.7,Realism:.65,Mathematism:.6,Spiritualism:.55,Pneumatism:.5,Sensationalism:.45,Materialism:.5,Phenomenalism:.55},vocational:{Monadism:.9,Dynamism:.85,Idealism:.8,Materialism:.7,Psychism:.7,Rationalism:.65,Phenomenalism:.6,Realism:.55,Spiritualism:.5,Pneumatism:.45,Sensationalism:.5,Mathematism:.55},environmental:{Pneumatism:.95,Realism:.85,Rationalism:.8,Materialism:.7,Dynamism:.65,Spiritualism:.6,Idealism:.55,Psychism:.5,Phenomenalism:.5,Sensationalism:.45,Monadism:.4,Mathematism:.55},interpersonal:{Monadism:.9,Psychism:.85,Idealism:.8,Spiritualism:.7,Dynamism:.65,Phenomenalism:.65,Pneumatism:.6,Sensationalism:.55,Rationalism:.55,Realism:.5,Materialism:.4,Mathematism:.35},intellectual:{Rationalism:.95,Realism:.9,Mathematism:.85,Materialism:.75,Idealism:.7,Dynamism:.6,Phenomenalism:.55,Monadism:.5,Psychism:.45,Spiritualism:.4,Sensationalism:.4,Pneumatism:.35}};return t[e]?t[e]:{Materialism:.6,Sensationalism:.6,Phenomenalism:.6,Realism:.6,Dynamism:.6,Monadism:.6,Idealism:.6,Rationalism:.6,Psychism:.6,Pneumatism:.6,Spiritualism:.6,Mathematism:.6}}function R(e){return{healthcare:"Healthcare prioritizes physical wellbeing, empirical evidence, and individual dignity. Materialism and Realism are weighted highly for their emphasis on physical health and objective medical facts. Rationalism supports systematic diagnosis. Monadism preserves individual dignity. Spiritualism is weighted lower but preserved for patients with religious concerns.",spiritual:"Spiritual formation prioritizes transcendent relationship, meaning-making, and psychological depth. Spiritualism is weighted highest for divine relationship. Idealism and Psychism support consciousness development and emotional authenticity. Materialism is weighted lower but preserved for physical health considerations in spiritual practice.",education:"Education prioritizes consciousness development, systematic understanding, and growth. Idealism supports meaning-making. Rationalism enables logical thinking. Dynamism emphasizes transformation. Monadism preserves individual uniqueness. Materialism and Sensationalism are weighted lower but preserved for practical skill development.",vocational:"Vocational choice prioritizes individual uniqueness, growth, and meaningful work. Monadism emphasizes authentic calling. Dynamism supports transformation. Idealism provides meaning. Materialism is weighted moderately for financial security. All perspectives contribute to holistic vocational discernment.",environmental:"Environmental policy prioritizes ensouled nature, objective ecological facts, and systematic sustainability. Pneumatism is weighted highest for sacred presence in nature. Realism provides objective ecological data. Rationalism enables systematic analysis. Materialism and Monadism are weighted lower but preserved for human welfare considerations.",interpersonal:"Interpersonal relationships prioritize individual dignity, emotional authenticity, and meaning-making. Monadism emphasizes irreplaceable personhood. Psychism supports emotional congruence. Idealism provides meaning. Spiritualism offers sacred covenant perspective. Materialism and Mathematism are weighted lower but preserved for practical considerations.",intellectual:"Intellectual pursuits prioritize logical coherence, objective truth, and formal perfection. Rationalism is weighted highest for systematic reasoning. Realism provides objective grounding. Mathematism supports formal elegance. Spiritualism and Pneumatism are weighted lower but preserved for wisdom traditions and holistic knowing."}[e]||"No specific domain context provided. All worldviews weighted equally to avoid privileging any single perspective."}function A(e,t){if(!e||e.length===0)return{integrated:"Insufficient perspectives",confidence:0,reasoning:"No worldview evaluations provided"};const s=M(e),n={};for(const[m,f]of Object.entries(s))n[m]=f.reduce((b,y)=>{const S=t[y.worldview]||.5;return b+S},0);let i=0,o="Unresolved";for(const[m,f]of Object.entries(n))f>i&&(i=f,o=m);const c=Object.values(n).reduce((m,f)=>m+f,0),l=c>0?i/c:0,a=s[o]||[],d=W(o,a,t);return{judgment:o,integrated:o,confidence:Math.round(l*100)/100,reasoning:d,supportingWorldviews:a.map(m=>m.worldview),contributingWorldviews:e.map(m=>m.worldview),weightedScore:i,totalWeight:c}}function M(e){const t={};for(const s of e){const n=x(s.judgment);t[n]||(t[n]=[]),t[n].push(s)}return t}function x(e){const t=e.toLowerCase();return t.includes("permissible")&&!t.includes("impermissible")?"permissible":t.includes("impermissible")?"impermissible":t.includes("obligatory")||t.includes("required")?"obligatory":t.includes("forbidden")||t.includes("prohibited")?"forbidden":t.includes("virtuous")||t.includes("praiseworthy")?"virtuous":t.includes("vicious")||t.includes("blameworthy")?"vicious":t.includes("good")&&!t.includes("bad")?"good":t.includes("bad")||t.includes("wrong")?"bad":t.includes("right")&&!t.includes("wrong")?"right":t.includes("acceptable")?"acceptable":t.includes("unacceptable")?"unacceptable":t.includes("uncertain")?"uncertain":e}function W(e,t,s){if(t.length===0)return`Judgment: ${e} (no supporting worldviews)`;const n=t.map(i=>{const o=s[i.worldview]||.5,c=`(weight: ${Math.round(o*100)}%)`;return`- ${i.worldview} ${c}: ${i.reasoning||i.judgment}`});return`Integrated judgment: ${e}

Supporting worldviews:
${n.join(`
`)}`}function v(e,t){if(!e||!t)return[];const s=new Set(t.supportingWorldviews||[]);return e.filter(i=>!s.has(i.worldview)).map(i=>({worldview:i.worldview,judgment:i.judgment,reasoning:i.reasoning,relevantValues:i.relevantValues||[],perspectiveValue:`This perspective emphasizes: ${(i.relevantValues||[]).join(", ")}`}))}function _(e,t){if(!e||e.length===0)return{level:"low",score:0,factors:["No worldview evaluations provided"],uncertainties:["Cannot assess without worldview perspectives"]};const s=A(e,t),n=s.confidence;let i="low";n>=.75?i="high":n>=.5?i="moderate":i="low";const o=[],c=[],l=Object.keys(M(e)).length;l===1?o.push("All worldviews agree on judgment"):l===2?o.push("Most worldviews agree, with one dissenting position"):c.push(`Worldviews divided across ${l} different positions`),e.length>=10?o.push("Comprehensive consultation (10+ worldviews)"):e.length>=6?o.push("Moderate consultation (6-9 worldviews)"):c.push(`Limited consultation (${e.length} worldviews)`);const a=v(e,s);return a.length>0&&a.reduce((m,f)=>m+(t[f.worldview]||.5),0)>s.weightedScore*.3&&c.push("Significant minority perspective(s) present"),{level:i,score:n,factors:o,uncertainties:c,uncertaintySources:c}}function k(e,t,s,n){const i=[],o=e.integrated||e.judgment,c=e.supportingWorldviews||[];i.push(`# Integrated Moral Judgment
`),i.push(`**Judgment**: ${o}
`),i.push(`**Confidence**: ${e.confidence} (${e.confidence>=.75?"high":e.confidence>=.5?"moderate":"low"})
`),n&&n!=="general"?(i.push(`
## Domain Context: ${n.charAt(0).toUpperCase()+n.slice(1)}
`),i.push(R(n)),i.push(`
`)):(i.push(`
## Domain Context: General (No Specific Domain)
`),i.push(`No specific domain context provided. All worldviews weighted equally.
`)),i.push(`
## Supporting Worldviews (${c.length})
`);for(const d of c){const m=t.find(f=>f.worldview===d);if(m){const f=s[d]||.5;i.push(`
### ${d} (weight: ${Math.round(f*100)}%)
`),i.push(`**Judgment**: ${m.judgment}
`),i.push(`**Reasoning**: ${m.reasoning||"Not provided"}
`),m.relevantValues&&m.relevantValues.length>0&&i.push(`**Values**: ${m.relevantValues.join(", ")}
`)}}const l=v(t,e);if(l.length>0){i.push(`
## Minority Perspectives (${l.length})
`),i.push(`**Important**: These dissenting views must be acknowledged and considered:
`);for(const d of l){const m=s[d.worldview]||.5;i.push(`
### ${d.worldview} (weight: ${Math.round(m*100)}%)
`),i.push(`**Judgment**: ${d.judgment}
`),i.push(`**Reasoning**: ${d.reasoning||"Not provided"}
`),i.push(`**Perspective Value**: ${d.perspectiveValue}
`)}i.push(`
**Conditions under which minority view might be correct**: `),i.push(`Different domain context, different value priorities, or additional relevant information not currently available.
`)}const a=_(t,s);if(i.push(`
## Confidence Assessment
`),i.push(`**Level**: ${a.level}
`),i.push(`**Score**: ${a.score}
`),a.factors.length>0){i.push(`**Supporting Factors**:
`);for(const d of a.factors)i.push(`- ${d}
`)}if(a.uncertainties.length>0){i.push(`**Uncertainties**:
`);for(const d of a.uncertainties)i.push(`- ${d}
`)}return i.push(`
## Limitations and Epistemic Humility
`),i.push("This integrated judgment represents a weighted synthesis of multiple worldview perspectives. "),i.push("It is not a claim to absolute moral truth, but rather a reasoned integration given the current context and domain. "),i.push("All moral judgments are subject to revision with new information, different contexts, or reconsidered priorities. "),i.push(`Minority perspectives deserve serious consideration and may be correct under different circumstances.
`),i.join("")}const u={state:{currentResolution:null,resolutionHistory:[],currentDomain:"general",domainWeights:g("general"),conflictPatterns:[]},actions:{resolveConflict(e,t={}){const s=t.domain||u.state.currentDomain,n=g(s),i=[];i.push({name:"gather_perspectives",completed:!0,result:`Gathered ${e.length} worldview evaluations`});const o=E(e);i.push({name:"identify_conflicts",completed:!0,result:`Detected ${o.length} conflicts`}),i.push({name:"contextualize_domain",completed:!0,result:`Domain: ${s}`});const c=A(e,n);i.push({name:"integrate_judgments",completed:!0,result:`Integrated judgment: ${c.judgment}`});const l=v(e,c);i.push({name:"acknowledge_minority",completed:!0,result:`Identified ${l.length} minority views`});const a=k(c,e,n,s);i.push({name:"generate_justification",completed:!0,result:"Generated full justification"});const d=_(e,n);i.push({name:"assess_confidence",completed:!0,result:`Confidence: ${d.level}`});const m={id:`resolution_${Date.now()}`,timestamp:new Date().toISOString(),scenarioId:t.scenarioId||null,domain:s,judgment:c.judgment,integrated:c.integrated,confidence:c.confidence,confidenceLevel:d.level,conflicts:o.length,conflictDetails:o,supportingWorldviews:c.supportingWorldviews,minorityViews:l,justification:a,evaluations:e,weights:n,context:t,steps:i};return u.state.currentResolution=m,u.state.resolutionHistory.push(m),u.state.currentDomain=s,u.state.domainWeights=n,o.length>0&&u.state.conflictPatterns.push({conflicts:o.map(f=>`${f.worldview1} vs ${f.worldview2}`),domain:s,timestamp:m.timestamp}),o.length>0&&u.emit("conflictDetected",{conflicts:o,domain:s,resolutionId:m.id}),l.length>0&&u.emit("minorityViewIdentified",{minorityViews:l,resolutionId:m.id}),u.emit("resolutionGenerated",m),u.emit("confidenceAssessed",{confidence:d.score,level:d.level,score:d.score,factors:d.factors,uncertainties:d.uncertainties}),m},setDomain(e){const s=["healthcare","spiritual","education","vocational","environmental","interpersonal","intellectual","general"].includes(e)?e:"general";u.state.currentDomain=s,u.state.domainWeights=g(s),u.emit("domainSet",{domain:s})},getResolutionHistory(e){return e?u.state.resolutionHistory.filter(t=>t.context&&t.context.scenarioId===e):u.state.resolutionHistory},explainResolution(e){const t=u.state.resolutionHistory.find(s=>s.id===e);return t?t.justification:null},getCurrentWeights(){return u.state.domainWeights},reset(){u.state.currentResolution=null,u.state.resolutionHistory=[],u.state.currentDomain="general",u.state.domainWeights=g("general"),u.state.conflictPatterns=[],u.emit("reset")}},listeners:{},on(e,t){return this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t),()=>{this.listeners[e]=this.listeners[e].filter(s=>s!==t)}},emit(e,t){this.listeners[e]&&this.listeners[e].forEach(s=>s(t))},events:{on(e,t){return u.on(e,t)}}};function V(e){const t=[];if(!e||typeof e!="object")return t.push("Scenario must be an object"),{valid:!1,errors:t};if(e.description?typeof e.description!="string"?t.push("Scenario description must be a string"):e.description.length<10?t.push("Scenario description must be at least 10 characters"):e.description.length>5e3&&t.push("Scenario description must be less than 5000 characters"):t.push("Scenario description is required"),e.id!==void 0&&(typeof e.id!="string"?t.push("Scenario id must be a string"):e.id.length===0&&t.push("Scenario id cannot be empty")),e.domain!==void 0){const s=["healthcare","spiritual","education","vocational","environmental","interpersonal","intellectual","general"];s.includes(e.domain)||t.push(`Invalid domain: ${e.domain}. Must be one of: ${s.join(", ")}`)}return e.context!==void 0&&(typeof e.context!="object"||Array.isArray(e.context))&&t.push("Scenario context must be an object"),{valid:t.length===0,errors:t}}function z(e){const t=[];if(!e||typeof e!="object")return t.push("Evaluation must be an object"),{valid:!1,errors:t};const s=["Materialism","Sensationalism","Phenomenalism","Realism","Dynamism","Monadism","Idealism","Rationalism","Psychism","Pneumatism","Spiritualism","Mathematism"];e.worldview?s.includes(e.worldview)||t.push(`Invalid worldview: ${e.worldview}`):t.push("Worldview name is required");const n=["permissible","impermissible","uncertain"];return e.judgment?n.includes(e.judgment)||t.push(`Invalid judgment: ${e.judgment}`):t.push("Judgment is required"),e.confidence===void 0||e.confidence===null?t.push("Confidence is required"):typeof e.confidence!="number"?t.push("Confidence must be a number"):(e.confidence<0||e.confidence>1)&&t.push("Confidence must be between 0 and 1"),e.reasoning?typeof e.reasoning!="string"?t.push("Reasoning must be a string"):e.reasoning.length<10&&t.push("Reasoning must be at least 10 characters"):t.push("Reasoning is required"),e.values!==void 0&&(Array.isArray(e.values)?e.values.every(i=>typeof i=="string")||t.push("All values must be strings"):t.push("Values must be an array")),e.weight!==void 0&&(typeof e.weight!="number"?t.push("Weight must be a number"):(e.weight<0||e.weight>1)&&t.push("Weight must be between 0 and 1")),{valid:t.length===0,errors:t}}function O(e){const t=[];if(!e||typeof e!="object")return t.push("Result must be an object"),{valid:!1,errors:t};const s=["id","timestamp","scenario","domain","judgment","confidence","confidenceLevel","worldviews","conflicts","minorityViews","supportingWorldviews","justification","steps","metadata"];for(const o of s)(e[o]===void 0||e[o]===null)&&t.push(`Missing required field: ${o}`);e.id&&typeof e.id!="string"&&t.push("id must be a string"),e.timestamp&&(typeof e.timestamp!="string"?t.push("timestamp must be a string"):isNaN(Date.parse(e.timestamp))&&t.push("timestamp must be a valid ISO 8601 date-time string"));const n=["permissible","impermissible","uncertain"];e.judgment&&!n.includes(e.judgment)&&t.push(`Invalid judgment: ${e.judgment}`),e.confidence!==void 0&&(typeof e.confidence!="number"?t.push("confidence must be a number"):(e.confidence<0||e.confidence>1)&&t.push("confidence must be between 0 and 1"));const i=["low","moderate","high"];if(e.confidenceLevel&&!i.includes(e.confidenceLevel)&&t.push(`Invalid confidenceLevel: ${e.confidenceLevel}`),e.worldviews&&(Array.isArray(e.worldviews)?e.worldviews.length===0?t.push("worldviews array cannot be empty"):e.worldviews.forEach((o,c)=>{const l=z(o);l.valid||t.push(`Worldview ${c}: ${l.errors.join(", ")}`)}):t.push("worldviews must be an array")),e.steps)if(!Array.isArray(e.steps))t.push("steps must be an array");else if(e.steps.length!==7)t.push("steps must contain exactly 7 steps");else{const o=["gather_perspectives","identify_conflicts","contextualize_domain","integrate_judgments","acknowledge_minority","generate_justification","assess_confidence"],c=e.steps.filter(l=>!o.includes(l));c.length>0&&t.push(`Invalid steps: ${c.join(", ")}`)}if(e.metadata)if(typeof e.metadata!="object")t.push("metadata must be an object");else{const o=["evaluationsCount","conflictsCount","minorityViewsCount","completedAt"];for(const c of o)(e.metadata[c]===void 0||e.metadata[c]===null)&&t.push(`metadata missing required field: ${c}`);e.metadata.evaluationsCount!==void 0&&typeof e.metadata.evaluationsCount!="number"&&t.push("metadata.evaluationsCount must be a number"),e.metadata.conflictsCount!==void 0&&typeof e.metadata.conflictsCount!="number"&&t.push("metadata.conflictsCount must be a number"),e.metadata.minorityViewsCount!==void 0&&typeof e.metadata.minorityViewsCount!="number"&&t.push("metadata.minorityViewsCount must be a number"),e.metadata.completedAt&&(typeof e.metadata.completedAt!="string"?t.push("metadata.completedAt must be a string"):isNaN(Date.parse(e.metadata.completedAt))&&t.push("metadata.completedAt must be a valid ISO 8601 date-time string"))}return{valid:t.length===0,errors:t}}const L={harm:["harm","hurt","injure","damage","destroy","kill","abuse","neglect"],help:["help","heal","cure","treat","support","aid","assist","care"],claim:["claim","assert","state","declare","argue","propose"],deceive:["lie","deceive","mislead","falsify","fabricate","conceal","hide"],reveal:["reveal","disclose","report","expose","uncover","admit"],allocate:["allocate","distribute","assign","give","take","share","divide"],prioritize:["prioritize","choose","select","prefer","favor"],force:["force","coerce","compel","require","mandate","impose"],allow:["allow","permit","enable","let","authorize"],prevent:["prevent","stop","block","restrict","prohibit","forbid"],leave:["leave","abandon","depart","exit","withdraw","separate"],join:["join","marry","unite","connect","commit"],betray:["betray","violate","break","cheat","dishonor"],work:["work","labor","create","produce","build","develop"],destroy:["destroy","eliminate","remove","demolish","dismantle"]},q={physicalImpact:["harm","injury","pain","suffering","death","dying","illness","disease","health","body","physical","bodily","medical","treatment","life support","terminal","fatal","life-threatening","organ","transplant","surgery"],factsInvolved:["fact","evidence","data","claim","truth","false","lie","honest","dishonest","report","falsify","fabricate","research","study","test"],truthClaims:["claim","assert","believe","doctrine","teaching","faith","creed","truth","reality","knowledge","certainty","doubt","question"],aesthetic:["beauty","art","music","literature","culture","aesthetic","creative","expression","artistic","experience","meaning","inspiration"],sensory:["feel","sense","experience","sensation","perception","awareness","consciousness","subjective","phenomenal","qualia"],personsInvolved:["person","people","individual","patient","student","employee","family","friend","parent","child","spouse","partner","colleague","community","someone","I","me","my","they","them","their","we","us"],communityImpact:["community","society","public","social","collective","group","town","city","nation","culture","tradition","custom","network","team"],resourceScarcity:["limited","scarce","only one","insufficient","shortage","competition","compete","allocate","distribute","priority","choose between","available"],financialStakes:["money","cost","expensive","afford","pay","income","salary","wage","debt","financial","economic","price","dollar","$","insurance"],moralConflict:["should","wrong","right","ethical","unethical","moral","immoral","duty","obligation","responsibility","conflict","tension","dilemma"],autonomyAtStake:["choice","decide","decision","autonomy","freedom","liberty","control","independent","self-determination","force","coerce","compel","require"],urgency:["urgent","emergency","immediate","now","crisis","critical","dying","deadline","time-sensitive","quickly","soon","imminent"],futureImpact:["future","long-term","generation","legacy","permanent","irreversible","career","lifetime","forever","children","grandchildren"],uncertainty:["uncertain","unknown","unclear","ambiguous","maybe","might","could","possibly","experimental","untested","risk","gamble","chance"],expertise:["expert","specialist","professional","trained","qualified","experienced","research","science","evidence-based","proven","studied"]},T={patient:["patient","sick person","ill person"],doctor:["doctor","physician","surgeon","medical professional"],family:["family","parent","child","spouse","sibling","relative"],student:["student","pupil","learner"],teacher:["teacher","professor","instructor","educator"],employee:["employee","worker","staff"],employer:["employer","boss","manager","company","corporation"],friend:["friend","best friend","close friend"],stranger:["stranger","unknown person"],community:["community","group","organization","society"],authority:["authority","government","police","official","regulator"],self:["I","me","my","myself"]},H={life:["life","survival","existence"],health:["health","wellbeing","wellness"],money:["money","income","wealth","financial security"],job:["job","career","employment","position","work"],relationship:["relationship","friendship","marriage","partnership"],reputation:["reputation","standing","honor","respect"],freedom:["freedom","liberty","autonomy","independence"],knowledge:["knowledge","truth","understanding","education"],environment:["environment","nature","wilderness","ecosystem","planet"],tradition:["tradition","custom","heritage","culture","faith"],safety:["safety","security","protection"]};function J(e){const t=e.toLowerCase(),s=e.split(/[.!?]+/);let n=null,i=0;for(const[o,c]of Object.entries(L))for(const l of c){const a=new RegExp(`(should|must|can|may|is it).*${l}`,"i");if(a.test(t)){const m=t.match(a);if(m)return m[0]}if(new RegExp(`\\b${l}\\w*\\b`,"i").test(t)){const m=1+(o==="harm"?2:0);m>i&&(i=m,n=l)}}if(n){const o=new RegExp(`([^.!?]*\\b${n}\\w*\\b[^.!?]*)`,"i"),c=e.match(o);return c?c[1].trim():n}return s[0]?.trim()||e.substring(0,100)}function K(e,t){const s=e.toLowerCase(),n={};for(const[i,o]of Object.entries(q))n[i]=o.some(c=>s.includes(c.toLowerCase()));return(t==="healthcare"||t==="medical")&&(n.physicalImpact=!0,n.personsInvolved=!0),(t==="spiritual"||t==="religious")&&(n.truthClaims=!0,n.communityImpact=!0),t==="environmental"&&(n.futureImpact=!0,n.communityImpact=!0),(t==="vocational"||t==="business")&&(n.financialStakes=!0,n.autonomyAtStake=!0),t==="interpersonal"&&(n.personsInvolved=!0,n.moralConflict=!0),n}function N(e){const t=e.toLowerCase(),s=[];for(const[n,i]of Object.entries(T))for(const o of i)t.includes(o)&&(s.find(c=>c.role===n)||s.push({role:n,mentioned:o}));return["i","me","my","myself"].some(n=>t.includes(` ${n} `)||t.startsWith(n))&&(s.find(n=>n.role==="self")||s.push({role:"self",mentioned:"I"})),s}function F(e){const t=e.toLowerCase(),s=[];for(const[n,i]of Object.entries(H))for(const o of i)t.includes(o)&&(s.find(c=>c.type===n)||s.push({type:n,mentioned:o}));return s}function B(e){const{context:t,agents:s,artifacts:n}=e;let i=0;const o=Object.values(t).filter(Boolean).length;return i+=Math.min(o*.05,.3),i+=Math.min(s.length*.1,.3),i+=Math.min(n.length*.08,.24),t.moralConflict&&(i+=.1),t.uncertainty&&(i+=.08),t.resourceScarcity&&(i+=.08),Math.min(i,1)}function G(e){const{description:t,domain:s,context:n={}}=e;if(!t||t.trim().length===0)throw new Error("Scenario description is required");const i=J(t),o=K(t,s),c=N(t),l=F(t),a={...o,...n},d={action:i,context:a,agents:c,artifacts:l,meta:{originalDescription:t,domain:s,complexity:0,parserVersion:"1.0.0",timestamp:new Date().toISOString()}};return d.meta.complexity=B(d),d}const D={state:{worldviews:{},valueHierarchies:{}}};function U(e,t){const s=[],{action:n,context:i,agents:o,artifacts:c}=e,l=n?.toLowerCase()||"";if(t.terminal&&t.terminal.forEach(a=>{let d=!1,m="medium";(a==="physical_wellbeing"||a==="material_security")&&(i.physicalImpact||c?.some(f=>f.type==="life"||f.type==="health")||l.match(/harm|health|pain|suffer|dying|terminal|cancer|treatment|medical|life support/))&&(d=!0,m="high"),a==="empirical_truth"&&(i.factsInvolved||i.expertise||l.match(/evidence|data|research|study|proven|medical fact/))&&(d=!0,m="high"),(a==="experiential_richness"||a==="hedonic_quality"||a==="aesthetic_beauty")&&(i.aesthetic||i.sensory||l.match(/experience|quality of life|pleasure|beauty|aesthetic/))&&(d=!0,m=i.aesthetic?"high":"medium"),(a==="interpretive_honesty"||a==="lived_experience"||a==="phenomenological_depth")&&(i.sensory||i.personsInvolved||o?.some(f=>f.role==="self"||f.role==="patient")||l.match(/experience|feel|perspective|interpret|prefer/))&&(d=!0,m="medium"),(a==="objective_truth"||a==="correspondence_to_reality"||a==="natural_law")&&(i.truthClaims||i.factsInvolved||l.match(/fact|truth|reality|objective|evidence/))&&(d=!0,m="high"),(a==="growth"||a==="transformation"||a==="vital_energy"||a==="creative_becoming")&&(i.futureImpact||l.match(/grow|develop|transform|evolve|change|progress/))&&(d=!0,m="medium"),(a==="individual_uniqueness"||a==="personal_identity"||a==="authentic_selfhood")&&(i.personsInvolved||o?.length>0||l.match(/individual|person|patient|self|identity|autonomy|dignity/))&&(d=!0,m=o?.some(f=>f.role==="self")?"high":"medium"),(a==="conceptual_coherence"||a==="rational_order"||a==="ideal_form")&&(i.moralConflict||l.match(/principle|concept|ideal|should|ought|right|wrong/))&&(d=!0,m="medium"),(a==="logical_consistency"||a==="systematic_knowledge"||a==="rational_certainty")&&(i.moralConflict||i.expertise||l.match(/rational|logic|reason|systematic|coherent|consistent/))&&(d=!0,m="medium"),(a==="consciousness_evolution"||a==="psychic_depth"||a==="interiority")&&(i.personsInvolved||i.moralConflict||l.match(/conscious|awareness|inner|mental|psychological|emotional/))&&(d=!0,m="medium"),(a==="spiritual_transcendence"||a==="sacred_meaning"||a==="divine_purpose")&&(i.truthClaims||l.match(/spirit|sacred|divine|soul|religious|faith|meaning|purpose/))&&(d=!0,m="medium"),(a==="eternal_truth"||a==="unchanging_principle"||a==="absolute_order")&&(i.truthClaims||i.moralConflict||l.match(/eternal|absolute|universal|principle|truth|law/))&&(d=!0,m="medium"),a.match(/autonomy|dignity|respect|freedom|liberty|rights/)&&(i.autonomyAtStake||i.personsInvolved||o?.length>0||l.match(/decide|choice|freedom|autonomy|consent|force|require/))&&(d=!0,m="high"),a.match(/justice|fairness|equity|care|compassion|wellbeing/)&&(i.personsInvolved||i.resourceScarcity||i.moralConflict||l.match(/fair|just|care|compassion|allocate|distribute/))&&(d=!0,m="medium"),d&&s.push({value:a,type:"terminal",salience:m})}),t.instrumental&&t.instrumental.forEach(a=>{s.push({value:a,type:"instrumental",salience:"low"})}),s.filter(a=>a.type==="terminal").length===0&&t.terminal&&t.terminal.length>0&&(i.physicalImpact&&t.terminal.includes("physical_wellbeing")&&s.push({value:"physical_wellbeing",type:"terminal",salience:"high"}),i.personsInvolved&&t.terminal.find(a=>a.match(/individual|person|dignity/)))){const a=t.terminal.find(d=>d.match(/individual|person|dignity/));s.push({value:a,type:"terminal",salience:"medium"})}return s}function X(e,t){const s=[],n=e.filter(i=>i.type==="terminal");return n.length>1&&s.push({type:"terminal_competition",values:n.map(i=>i.value),description:"Multiple terminal values compete for priority"}),s}function Y(e,t){if(t.length===0)return"neutral";const s=t.filter(i=>i.type==="terminal");if(s.length===0)return"neutral";const n=s.filter(i=>i.salience==="high");return n.length>1||n.length===1?"complex":"neutral"}function Q(e,t,s){const n=[];if(n.push(`From the ${s} perspective:`),e.length===0)return n.push("This scenario does not engage core values of this worldview."),n.join(" ");const i=e.filter(o=>o.type==="terminal");if(i.length>0){const o=i.map(c=>c.value).join(", ");n.push(`The terminal values of ${o} are at stake.`)}return t.length>0&&n.push(`However, there are ${t.length} value conflict(s) to resolve.`),n.join(" ")}function Z(e,t){if(e.length===0)return .1;const s=e.filter(i=>i.type==="terminal"),n=s.filter(i=>i.salience==="high");return n.length===1&&s.length===1?.9:n.length>1?.5:.6}function ee(e,t,s){const n=U(t,e),i=X(n),o=Y(t.action,n),c=Q(n,i,s),l=Z(n,t.context);return{judgment:o,reasoning:c,relevantValues:n,conflicts:i,confidence:l,worldview:s,timestamp:new Date().toISOString()}}function te(e){if(!e||typeof e!="string")return"general";const t=e.toLowerCase(),n=["patient","medical","doctor","hospital","health","disease","treatment","surgery","medicine","life support","diagnosis","therapy"].filter(h=>t.includes(h)).length,o=["god","divine","religious","spiritual","prayer","faith","sacred","church","worship","soul","scripture","belief"].filter(h=>t.includes(h)).length,l=["student","teacher","school","university","education","learning","class","exam","grade","curriculum","academic","study"].filter(h=>t.includes(h)).length,d=["job","career","work","employer","employee","salary","profession","occupation","hire","resign","promotion","workplace"].filter(h=>t.includes(h)).length,f=["environment","nature","climate","pollution","conservation","ecosystem","wildlife","forest","ocean","sustainability","species","habitat"].filter(h=>t.includes(h)).length,y=["relationship","friend","family","marriage","love","trust","partner","spouse","parent","child","sibling","intimacy"].filter(h=>t.includes(h)).length,$=["research","study","science","knowledge","theory","experiment","hypothesis","data","evidence","publication","journal","peer review"].filter(h=>t.includes(h)).length,j={healthcare:n,spiritual:o,education:l,vocational:d,environmental:f,interpersonal:y,intellectual:$},I=Math.max(...Object.values(j));if(I===0)return"general";for(const[h,P]of Object.entries(j))if(P===I)return h;return"general"}function ie(e,t,s={}){const n=["Materialism","Sensationalism","Phenomenalism","Realism","Dynamism","Monadism","Idealism","Rationalism","Psychism","Pneumatism","Spiritualism","Mathematism"];return s.worldviews&&Array.isArray(s.worldviews)&&s.worldviews.length>0?s.worldviews.filter(i=>n.includes(i)):n}function ne(e,t,s,n){const i=Array.isArray(e.steps)?e.steps.map(o=>typeof o=="string"?o:o.name):[];return{id:e.id,timestamp:e.timestamp,scenario:{description:n.description,domain:s,context:n.context||{}},domain:s,judgment:e.judgment,confidence:e.confidence,confidenceLevel:e.confidenceLevel,worldviews:t.map(o=>({worldview:o.worldview,judgment:o.judgment,confidence:o.confidence,reasoning:o.reasoning,values:o.values||[],weight:e.weights[o.worldview]||.5})),conflicts:e.conflictDetails,minorityViews:e.minorityViews,supportingWorldviews:e.supportingWorldviews,justification:e.justification,steps:i,metadata:{evaluationsCount:t.length,conflictsCount:e.conflicts,minorityViewsCount:e.minorityViews.length,completedAt:e.timestamp}}}const p={state:{currentDeliberation:null,deliberationInProgress:!1,lastError:null},actions:{async deliberateOnScenario(e,t={}){try{p.state.deliberationInProgress=!0,p.state.lastError=null,p.emit("deliberationStarted",{scenario:e});const s=V(e);if(!s.valid)throw new Error(`Invalid scenario input: ${s.errors.join(", ")}`);const n=e.domain||te(e.description);p.emit("domainDetected",{domain:n});const i=ie(e,n,t);p.emit("worldviewsSelected",{worldviews:i,count:i.length});const o=se(i,e,n);p.emit("evaluationsGenerated",{count:o.length}),u.actions.setDomain(n);const c=u.actions.resolveConflict(o,{scenarioId:e.id||`scenario_${Date.now()}`,description:e.description,domain:n});p.emit("conflictsResolved",{resolution:c});const l=ne(c,o,n,e),a=O(l);return a.valid||console.warn("Result validation warnings:",a.errors),p.state.currentDeliberation=l,p.state.deliberationInProgress=!1,p.emit("deliberationCompleted",{result:l}),l}catch(s){throw p.state.lastError=s.message,p.state.deliberationInProgress=!1,p.emit("deliberationFailed",{error:s.message}),s}},reset(){p.state.currentDeliberation=null,p.state.deliberationInProgress=!1,p.state.lastError=null,p.emit("reset")}},listeners:{},on(e,t){return this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t),()=>{this.listeners[e]=this.listeners[e].filter(s=>s!==t)}},emit(e,t){this.listeners[e]&&this.listeners[e].forEach(s=>s(t))}};function se(e,t,s){const n=G({description:t.description,domain:s,context:t.context||{}});return e.map(c=>{const l=D.state.worldviews[c],a=D.state.valueHierarchies[c];return!l||!a?(console.warn(`Worldview ${c} not found in worldviewManager, using fallback`),{name:c,values:{terminal:[],constitutive:[],instrumental:[]}}):{name:c,values:a}}).map(({name:c,values:l})=>{try{const a=ee(l,n,c);return{worldview:c,judgment:re(a.judgment),confidence:a.confidence,reasoning:a.reasoning,values:a.relevantValues.map(d=>d.value),meta:{conflicts:a.conflicts,complexity:n.meta.complexity}}}catch(a){return console.error(`Error evaluating worldview ${c}:`,a),{worldview:c,judgment:"uncertain",confidence:.1,reasoning:`Could not evaluate from ${c} perspective: ${a.message}`,values:[],meta:{error:a.message}}}})}function re(e){return{right:"permissible",wrong:"impermissible",neutral:"uncertain",complex:"uncertain"}[e]||"uncertain"}function oe(){const{subscribe:e,set:t,update:s}=C({currentDeliberation:p.state.currentDeliberation,inProgress:p.state.deliberationInProgress,lastError:p.state.lastError});return p.on("deliberationStarted",()=>{s(n=>({...n,inProgress:!0,lastError:null}))}),p.on("deliberationCompleted",({result:n})=>{s(i=>({...i,currentDeliberation:n,inProgress:!1,lastError:null}))}),p.on("deliberationFailed",({error:n})=>{s(i=>({...i,inProgress:!1,lastError:n}))}),p.on("reset",()=>{t({currentDeliberation:null,inProgress:!1,lastError:null})}),{subscribe:e,async deliberate(n,i={}){try{return await p.actions.deliberateOnScenario(n,i)}catch(o){throw console.error("Deliberation failed:",o),o}},reset(){p.actions.reset()}}}const ye=oe();class ae{async getItem(t){throw new Error("getItem not implemented")}async setItem(t,s){throw new Error("setItem not implemented")}async removeItem(t){throw new Error("removeItem not implemented")}async getAllKeys(){throw new Error("getAllKeys not implemented")}async clear(){throw new Error("clear not implemented")}}class ce extends ae{constructor(){super(),this.store=new Map}async getItem(t){const s=this.store.get(t);return s!==void 0?JSON.parse(JSON.stringify(s)):null}async setItem(t,s){this.store.set(t,JSON.parse(JSON.stringify(s)))}async removeItem(t){this.store.delete(t)}async getAllKeys(){return Array.from(this.store.keys())}async clear(){this.store.clear()}}function le(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function de(e,t={}){return{id:le(),userId:e,createdAt:new Date().toISOString(),lastActivity:new Date().toISOString(),preferences:{defaultWorldviews:t.defaultWorldviews||[],customWeights:t.customWeights||{},theme:t.theme||"light",...t}}}function w(e){return{...e,lastActivity:new Date().toISOString()}}function me(e,t){return{...e,...t,customWeights:{...e.customWeights||{},...t.customWeights||{}}}}function ue(e){return{id:e.id,timestamp:e.timestamp,scenario:e.scenario.description,domain:e.domain,judgment:e.judgment,confidence:e.confidence,confidenceLevel:e.confidenceLevel,worldviewsCount:e.worldviews.length,conflictsCount:e.metadata.conflictsCount}}function pe(e,t={}){if(!e||e.length===0)return[];let s=[...e];if(t.domain&&(s=s.filter(n=>n.domain===t.domain)),t.judgment&&(s=s.filter(n=>n.judgment===t.judgment)),t.startDate){const n=new Date(t.startDate).getTime();s=s.filter(i=>new Date(i.timestamp).getTime()>=n)}if(t.endDate){const n=new Date(t.endDate).getTime();s=s.filter(i=>new Date(i.timestamp).getTime()<=n)}return t.confidenceLevel&&(s=s.filter(n=>n.confidenceLevel===t.confidenceLevel)),t.limit&&t.limit>0&&(s=s.slice(0,t.limit)),s}function fe(e,t="timestamp",s="desc"){if(!e||e.length===0)return[];const n=[...e];return n.sort((i,o)=>{let c,l;switch(t){case"timestamp":c=new Date(i.timestamp).getTime(),l=new Date(o.timestamp).getTime();break;case"confidence":c=i.confidence,l=o.confidence;break;case"domain":c=i.domain,l=o.domain;break;default:c=new Date(i.timestamp).getTime(),l=new Date(o.timestamp).getTime()}return s==="asc"?c>l?1:c<l?-1:0:c<l?1:c>l?-1:0}),n}const r={state:{currentSession:null,currentDeliberation:null,history:[],storageAdapter:null,isInitialized:!1,lastError:null},actions:{async initialize(e=null){try{const t=e||new ce;r.state.storageAdapter=t;const s=await t.getItem("current_session");s&&(r.state.currentSession=w(s),r.emit("sessionRestored",{session:r.state.currentSession}));const n=await t.getItem("deliberation_history");n&&Array.isArray(n)&&(r.state.history=n),r.state.isInitialized=!0,r.state.lastError=null,r.emit("initialized",{hasSession:!!r.state.currentSession,historyCount:r.state.history.length})}catch(t){throw r.state.lastError=t.message,r.emit("error",{error:t.message,action:"initialize"}),t}},async createSession(e,t={}){if(!r.state.isInitialized)throw new Error("SessionManager not initialized. Call initialize() first.");try{const s=de(e,t);return r.state.currentSession=s,await r.state.storageAdapter.setItem("current_session",s),r.emit("sessionCreated",{session:s}),s}catch(s){throw r.state.lastError=s.message,r.emit("error",{error:s.message,action:"createSession"}),s}},async endSession(){if(r.state.currentSession)try{const e=r.state.currentSession;r.state.currentSession=null,r.state.currentDeliberation=null,await r.state.storageAdapter.removeItem("current_session"),r.emit("sessionEnded",{session:e})}catch(e){throw r.state.lastError=e.message,r.emit("error",{error:e.message,action:"endSession"}),e}},async updatePreferences(e){if(!r.state.currentSession)throw new Error("No active session");try{const t=me(r.state.currentSession.preferences,e);return r.state.currentSession={...r.state.currentSession,preferences:t,lastActivity:new Date().toISOString()},await r.state.storageAdapter.setItem("current_session",r.state.currentSession),r.emit("preferencesUpdated",{preferences:t}),t}catch(t){throw r.state.lastError=t.message,r.emit("error",{error:t.message,action:"updatePreferences"}),t}},getPreferences(){return r.state.currentSession?r.state.currentSession.preferences:{defaultWorldviews:[],customWeights:{},theme:"light"}},async saveDeliberation(e){if(!r.state.isInitialized)throw new Error("SessionManager not initialized");try{const t=ue(e);return r.state.history.unshift(t),r.state.history.length>100&&(r.state.history=r.state.history.slice(0,100)),r.state.currentDeliberation=e,await r.state.storageAdapter.setItem("deliberation_history",r.state.history),r.state.currentSession&&(r.state.currentSession=w(r.state.currentSession),await r.state.storageAdapter.setItem("current_session",r.state.currentSession)),r.emit("deliberationSaved",{deliberation:t}),t}catch(t){throw r.state.lastError=t.message,r.emit("error",{error:t.message,action:"saveDeliberation"}),t}},getHistory(e={}){let t=[...r.state.history];return(e.domain||e.judgment||e.startDate||e.endDate||e.confidenceLevel||e.limit)&&(t=pe(t,e)),(e.sortBy||e.order)&&(t=fe(t,e.sortBy,e.order)),t},getDeliberationById(e){return r.state.history.find(t=>t.id===e)||null},async clearHistory(){if(!r.state.isInitialized)throw new Error("SessionManager not initialized");try{r.state.history=[],r.state.currentDeliberation=null,await r.state.storageAdapter.setItem("deliberation_history",[]),r.emit("historyCleared")}catch(e){throw r.state.lastError=e.message,r.emit("error",{error:e.message,action:"clearHistory"}),e}},exportSessionData(){return{session:r.state.currentSession,history:r.state.history,exportedAt:new Date().toISOString()}},async importSessionData(e){if(!r.state.isInitialized)throw new Error("SessionManager not initialized");try{e.session&&(r.state.currentSession=w(e.session),await r.state.storageAdapter.setItem("current_session",r.state.currentSession)),e.history&&Array.isArray(e.history)&&(r.state.history=e.history,await r.state.storageAdapter.setItem("deliberation_history",e.history)),r.emit("sessionDataImported",{hasSession:!!e.session,historyCount:e.history?.length||0})}catch(t){throw r.state.lastError=t.message,r.emit("error",{error:t.message,action:"importSessionData"}),t}},async reset(){r.state.currentSession=null,r.state.currentDeliberation=null,r.state.history=[],r.state.lastError=null,r.state.isInitialized=!1,r.state.storageAdapter&&await r.state.storageAdapter.clear(),r.emit("reset")}},listeners:{},on(e,t){return this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t),()=>{this.listeners[e]=this.listeners[e].filter(s=>s!==t)}},emit(e,t){this.listeners[e]&&this.listeners[e].forEach(s=>s(t))}};function he(){const{subscribe:e,set:t,update:s}=C({currentSession:r.state.currentSession,currentDeliberation:r.state.currentDeliberation,history:r.state.history,isInitialized:r.state.isInitialized,lastError:r.state.lastError});return r.on("initialized",({hasSession:n,historyCount:i})=>{s(o=>({...o,currentSession:r.state.currentSession,history:r.state.history,isInitialized:!0}))}),r.on("sessionCreated",({session:n})=>{s(i=>({...i,currentSession:n}))}),r.on("sessionEnded",()=>{s(n=>({...n,currentSession:null,currentDeliberation:null}))}),r.on("preferencesUpdated",({preferences:n})=>{s(i=>({...i,currentSession:r.state.currentSession}))}),r.on("deliberationSaved",({deliberation:n})=>{s(i=>({...i,currentDeliberation:r.state.currentDeliberation,history:r.state.history}))}),r.on("historyCleared",()=>{s(n=>({...n,history:[],currentDeliberation:null}))}),r.on("error",({error:n})=>{s(i=>({...i,lastError:n}))}),{subscribe:e,async createSession(n,i={}){try{return await r.actions.createSession(n,i)}catch(o){throw console.error("Failed to create session:",o),o}},async endSession(){try{await r.actions.endSession()}catch(n){throw console.error("Failed to end session:",n),n}},async updatePreferences(n){try{return await r.actions.updatePreferences(n)}catch(i){throw console.error("Failed to update preferences:",i),i}},getPreferences(){return r.actions.getPreferences()},async saveDeliberation(n){try{return await r.actions.saveDeliberation(n)}catch(i){throw console.error("Failed to save deliberation:",i),i}},getHistory(n={}){return r.actions.getHistory(n)},getDeliberationById(n){return r.actions.getDeliberationById(n)},async clearHistory(){try{await r.actions.clearHistory()}catch(n){throw console.error("Failed to clear history:",n),n}},exportData(){return r.actions.exportSessionData()},async importData(n){try{await r.actions.importSessionData(n)}catch(i){throw console.error("Failed to import session data:",i),i}}}}const we=he();export{ye as d,we as s,V as v};
