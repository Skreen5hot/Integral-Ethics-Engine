import*as p from"devalue";import{t as L,b as B,c as P}from"./utils.js";import{SvelteKitError as T}from"@sveltejs/kit/internal";function M(s,t,e){t.startsWith("n:")?(t=t.slice(2),e=e===""?void 0:parseFloat(e)):t.startsWith("b:")&&(t=t.slice(2),e=e==="on"),W(s,S(t),e)}function N(s){const t={};for(let e of s.keys()){const n=e.endsWith("[]");let r=s.getAll(e);if(n&&(e=e.slice(0,-2)),r.length>1&&!n)throw new Error(`Form cannot contain duplicated keys â€” "${e}" has ${r.length} values`);r=r.filter(i=>typeof i=="string"||i.name!==""||i.size>0),e.startsWith("n:")?(e=e.slice(2),r=r.map(i=>i===""?void 0:parseFloat(i))):e.startsWith("b:")&&(e=e.slice(2),r=r.map(i=>i==="on")),M(t,e,n?r:r[0])}return t}const D="application/x-sveltekit-formdata",j=0,A=7;async function Z(s){if(s.headers.get("content-type")!==D){const a=await s.formData();return{data:N(a),meta:{},form_data:a}}if(!s.body)throw w("no body");const t=parseInt(s.headers.get("content-length")??"");if(Number.isNaN(t))throw w("invalid Content-Length header");const e=s.body.getReader(),n=[];function r(a){if(a in n)return n[a];let l=n.length;for(;l<=a;)n[l]=e.read().then(h=>h.value),l++;return n[a]}async function i(a,l){let h,b=0,k;for(k=0;;k++){const m=await r(k);if(!m)return null;const I=b+m.byteLength;if(a>=b&&a<I){h=m;break}b=I}if(a+l<=b+h.byteLength)return h.subarray(a-b,a+l-b);const $=[h.subarray(a-b)];let v=h.byteLength-a+b;for(;v<l;){k++;let m=await r(k);if(!m)return null;m.byteLength>l-v&&(m=m.subarray(0,l-v)),$.push(m),v+=m.byteLength}const E=new Uint8Array(l);v=0;for(const m of $)E.set(m,v),v+=m.byteLength;return E}const c=await i(0,A);if(!c)throw w("too short");if(c[0]!==j)throw w(`got version ${c[0]}, expected version ${j}`);const f=new DataView(c.buffer,c.byteOffset,c.byteLength),d=f.getUint32(1,!0);if(A+d>t)throw w("data overflow");const y=f.getUint16(5,!0);if(A+d+y>t)throw w("file offset table overflow");const o=await i(A,d);if(!o)throw w("data too short");let u,_;if(y>0){const a=await i(A+d,y);if(!a)throw w("file offset table too short");u=JSON.parse(L.decode(a)),_=A+d+y}const[O,g]=p.parse(L.decode(o),{File:([a,l,h,b,k])=>{if(_+u[k]+h>t)throw w("file data overflow");return new Proxy(new z(a,l,h,b,r,_+u[k]),{getPrototypeOf(){return File.prototype}})}});return(async()=>{let a=!0;for(;a;)a=!!await r(n.length)})(),{data:O,meta:g,form_data:null}}function w(s){return new T(400,"Bad Request",`Could not deserialize binary form: ${s}`)}class z{#t;#e;constructor(t,e,n,r,i,c){this.name=t,this.type=e,this.size=n,this.lastModified=r,this.webkitRelativePath="",this.#t=i,this.#e=c,this.arrayBuffer=this.arrayBuffer.bind(this),this.bytes=this.bytes.bind(this),this.slice=this.slice.bind(this),this.stream=this.stream.bind(this),this.text=this.text.bind(this)}#r;async arrayBuffer(){return this.#r??=await new Response(this.stream()).arrayBuffer(),this.#r}async bytes(){return new Uint8Array(await this.arrayBuffer())}slice(t=0,e=this.size,n=this.type){t<0?t=Math.max(this.size+t,0):t=Math.min(t,this.size),e<0?e=Math.max(this.size+e,0):e=Math.min(e,this.size);const r=Math.max(e-t,0);return new z(this.name,n,r,this.lastModified,this.#t,this.#e+t)}stream(){let t=0,e=0;return new ReadableStream({start:async n=>{let r=0,i=null;for(e=0;;e++){const c=await this.#t(e);if(!c)return null;const f=r+c.byteLength;if(this.#e>=r&&this.#e<f){i=c;break}r=f}this.#e+this.size<=r+i.byteLength?(n.enqueue(i.subarray(this.#e-r,this.#e+this.size-r)),n.close()):(n.enqueue(i.subarray(this.#e-r)),t=i.byteLength-this.#e+r)},pull:async n=>{e++;let r=await this.#t(e);if(!r){n.error("incomplete file data"),n.close();return}r.byteLength>this.size-t&&(r=r.subarray(0,this.size-t)),n.enqueue(r),t+=r.byteLength,t>=this.size&&n.close()}})}async text(){return L.decode(await this.arrayBuffer())}}const F=/^[a-zA-Z_$]\w*(\.[a-zA-Z_$]\w*|\[\d+\])*$/;function S(s){if(!F.test(s))throw new Error(`Invalid path ${s}`);return s.split(/\.|\[|\]/).filter(Boolean)}function R(s){if(s==="__proto__"||s==="constructor"||s==="prototype")throw new Error(`Invalid key "${s}"`)}function W(s,t,e){let n=s;for(let i=0;i<t.length-1;i+=1){const c=t[i];R(c);const f=/^\d+$/.test(t[i+1]),d=Object.hasOwn(n,c),y=n[c];if(d&&f!==Array.isArray(y))throw new Error(`Invalid array key ${t[i+1]}`);d||(n[c]=f?[]:{}),n=n[c]}const r=t[t.length-1];R(r),n[r]=e}function G(s,t=!1){const e={name:"",path:[],message:s.message,server:t};if(s.path!==void 0){let n="";for(const r of s.path){const i=typeof r=="object"?r.key:r;e.path.push(i),typeof i=="number"?n+=`[${i}]`:typeof i=="string"&&(n+=n===""?i:"."+i)}e.name=n}return e}function J(s){const t={};for(const e of s){(t.$??=[]).push(e);let n="";if(e.path!==void 0)for(const r of e.path)typeof r=="number"?n+=`[${r}]`:typeof r=="string"&&(n+=n===""?r:"."+r),(t[n]??=[]).push(e)}return t}function U(s,t){let e=s;for(const n of t){if(e==null||typeof e!="object")return e;e=e[n]}return e}function x(s,t,e,n,r=[]){const i=()=>U(t(),r);return new Proxy(s,{get(c,f){if(typeof f=="symbol")return c[f];if(/^\d+$/.test(f))return x({},t,e,n,[...r,parseInt(f,10)]);const d=Y(r);return f==="set"?x(function(o){return e(r,o),o},t,e,n,[...r,f]):f==="value"?x(i,t,e,n,[...r,f]):f==="issues"||f==="allIssues"?x(()=>{const o=n()[d===""?"$":d];return f==="allIssues"?o?.map(u=>({path:u.path,message:u.message})):o?.filter(u=>u.name===d)?.map(u=>({path:u.path,message:u.message}))},t,e,n,[...r,f]):f==="as"?x((o,u)=>{const _=o==="file multiple"||o==="select multiple"||o==="checkbox"&&typeof u=="string",g={name:(o==="number"||o==="range"?"n:":o==="checkbox"&&!_?"b:":"")+d+(_?"[]":""),get"aria-invalid"(){const a=n();return d in a?"true":void 0}};return o!=="text"&&o!=="select"&&o!=="select multiple"&&(g.type=o==="file multiple"?"file":o),o==="submit"||o==="hidden"?Object.defineProperties(g,{value:{value:u,enumerable:!0}}):o==="select"||o==="select multiple"?Object.defineProperties(g,{multiple:{value:_,enumerable:!0},value:{enumerable:!0,get(){return i()}}}):o==="checkbox"||o==="radio"?Object.defineProperties(g,{value:{value:u??"on",enumerable:!0},checked:{enumerable:!0,get(){const a=i();return o==="radio"?a===u:_?(a??[]).includes(u):a}}}):o==="file"||o==="file multiple"?Object.defineProperties(g,{multiple:{value:_,enumerable:!0},files:{enumerable:!0,get(){const a=i();if(a instanceof File){if(typeof DataTransfer<"u"){const l=new DataTransfer;return l.items.add(a),l.files}return{0:a,length:1}}if(Array.isArray(a)&&a.every(l=>l instanceof File)){if(typeof DataTransfer<"u"){const h=new DataTransfer;return a.forEach(b=>h.items.add(b)),h.files}const l={length:a.length};return a.forEach((h,b)=>{l[b]=h}),l}return null}}}):Object.defineProperties(g,{value:{enumerable:!0,get(){const a=i();return a!=null?String(a):""}}})},t,e,n,[...r,"as"]):x({},t,e,n,[...r,f])}})}function Y(s){let t="";for(const e of s)typeof e=="number"?t+=`[${e}]`:t+=t===""?e:"."+e;return t}const K="x-sveltekit-invalidated",q="x-sveltekit-trailing-slash";function C(s,t){const e=Object.fromEntries(Object.entries(t).map(([n,r])=>[n,r.encode]));return p.stringify(s,e)}function Q(s,t){if(s===void 0)return"";const e=C(s,t),n=new TextEncoder().encode(e);return B(n).replaceAll("=","").replaceAll("+","-").replaceAll("/","_")}function X(s,t){if(!s)return;const e=L.decode(P(s.replaceAll("-","+").replaceAll("_","/"))),n=Object.fromEntries(Object.entries(t).map(([r,i])=>[r,i.decode]));return p.parse(e,n)}function ee(s,t){return s+"/"+t}export{D as B,K as I,q as T,Q as a,x as b,ee as c,Z as d,M as e,J as f,W as g,G as n,X as p,C as s};
